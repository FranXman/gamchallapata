<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Musicoter√°pia</title>
  <style>
    /* Tema Oscuro */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #1e1e1e, #333);
      color: #fff;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    /* Tema Claro */
    body.light-mode {
      background: linear-gradient(135deg, #f9f9f9, #ffffff);
      color: #333;
    }
    /* Contenedor principal */
    .container {
      display: grid;
      grid-template-columns: 22% 56% 22%; /* Proporciones precisas */
      grid-template-rows: 1fr; /* Ajustado para ocupar todo el espacio disponible */
      gap: 5px;
      padding: 10px;
      height: calc(100vh - 20px); /* Altura ajustada */
    }
    /* Panel izquierdo */
    #sidebar-left {
      grid-column: 1;
      background: linear-gradient(135deg, #2c2c2c, #444);
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: calc(100% - 5%); /* Reducir lista de videos en 5% */
    }
    body.light-mode #sidebar-left {
      background: linear-gradient(135deg, #ffffff, #f0f0f0);
      color: #333;
      border: 1px solid #ddd;
    }
    /* Previsualizaci√≥n */
    #preview-video-container {
      flex: 0 0 150px;
      border: 2px solid #ff6f61;
      border-radius: 5px;
      overflow: hidden;
    }
    #preview-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: black;
    }
    /* Lista de videos */
    #video-list {
      flex: 1;
      overflow: hidden; /* Ocultar barra de desplazamiento */
      border: 2px solid #ff6f61;
      border-radius: 5px;
      padding: 5px;
      height: calc(100% - 5%); /* Reducir lista de videos en 5% */
    }
    #available-videos {
      overflow-y: auto; /* Habilitar desplazamiento interno */
      scroll-behavior: smooth; /* Desplazamiento suave */
      max-height: 100%; /* Limitar altura */
      padding-right: 15px; /* Espacio para evitar recorte */
    }
    /* Ocultar barra de desplazamiento */
    #available-videos::-webkit-scrollbar {
      display: none; /* Ocultar barra en navegadores basados en WebKit */
    }
    #available-videos {
      -ms-overflow-style: none; /* Ocultar barra en IE/Edge */
      scrollbar-width: none; /* Ocultar barra en Firefox */
    }
    /* Pantalla principal */
    #main-screen {
      grid-column: 2;
      position: relative;
      background: black;
      border: 2px solid #ff6f61;
      border-radius: 5px;
      overflow: hidden;
      height: calc(100% - 20%); /* Reducir pantalla de emisi√≥n en 20% */
    }
    #main-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      max-width: 100%;
      max-height: 100%;
    }
    /* Marquesina en la parte inferior */
    #upper-marquee {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      color: white;
      font-size: 1.2rem;
      text-align: center;
      animation: marquee 10s linear infinite;
      z-index: 10;
    }
    /* Upper third (mostrar cr√©ditos) */
    #upper-third {
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #00ff7f, #00b34d);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      padding: 10px;
      border-radius: 5px;
      position: absolute;
      display: block;
    }
    /* Lower third */
    #lower-third {
      position: absolute;
      bottom: 18%; /* Subir 8% m√°s arriba */
      left: 18%; /* Alinear con el disco vinilo + 3% */
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
      color: white;
      font-size: 1.8rem; /* Aumentar tama√±o de fuente */
      font-weight: bold;
      max-width: 40%;
      padding: 15px;
      border-radius: 10px;
      display: none;
      animation: fadeInOut 2s ease-in-out;
    }
    /* Dise√±o de disco vinilo */
    #vinyl {
      position: absolute;
      bottom: 18%; /* Alinear con lower-third */
      left: 10%; /* Posici√≥n relativa al lado izquierdo */
      width: 80px; /* Hacer el vinilo m√°s grande */
      height: 80px; /* Hacer el vinilo m√°s grande */
      background: radial-gradient(circle, #333, #000);
      border-radius: 50%;
      border: 2px solid #ff6f61;
      animation: spin 5s linear infinite;
      display: none; /* Ocultar por defecto */
    }
    /* Centro del disco vinilo */
    #vinyl::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px; /* Tama√±o del c√≠rculo central */
      height: 30px; /* Tama√±o del c√≠rculo central */
      background: yellow; /* Color amarillo */
      border-radius: 50%;
    }
    /* Espacio transparente dentro del c√≠rculo central */
    #vinyl::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 15px; /* Tama√±o del espacio transparente */
      height: 15px; /* Tama√±o del espacio transparente */
      background: transparent; /* Espacio transparente */
      border-radius: 50%;
    }
    /* Animaci√≥n de giro del disco */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Animaci√≥n de la marquesina */
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    /* Botones de acci√≥n */
    #select-folder,
    #theme-toggle {
      position: fixed;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    #select-folder { bottom: 60px; }
    #theme-toggle { bottom: 10px; }
    body.light-mode #select-folder,
    body.light-mode #theme-toggle {
      color: #333;
    }
    /* Mejoras en lista de videos */
    .letter-header {
      background: linear-gradient(135deg, #333, #444);
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
      transition: transform 0.2s ease;
    }
    body.light-mode .letter-header {
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      color: #00796b;
      border: 1px solid #00796b;
    }
    .letter-header:hover,
    .letter-header.selected {
      transform: scale(1.05);
      background: linear-gradient(135deg, #ff6f61, #ff4d4d);
      color: white;
    }
    .letter-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .letter-content.open {
      max-height: 1000px;
    }
    .letter-content li {
      padding: 10px;
      cursor: pointer;
      background: linear-gradient(135deg, #333, #444);
      margin: 2px 0;
      border-radius: 5px;
    }
    body.light-mode .letter-content li {
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      color: #00796b;
      border: 1px solid #00796b;
    }
    .letter-content li.selected {
      background: linear-gradient(135deg, #ff6f61, #ff4d4d);
      color: white;
      font-weight: bold;
      transform: scale(1.02);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Panel Izquierdo -->
    <div id="sidebar-left">
      <div id="preview-video-container">
        <video id="preview-video" muted loop></video>
      </div>
      <div id="video-list">
        <h2>Videos Disponibles</h2>
        <div id="available-videos"></div>
      </div>
    </div>
    <!-- Pantalla Principal -->
    <section id="main-screen">
      <video id="main-video" controls autoplay></video>
      <div id="vinyl"></div>
      <div id="lower-third"></div>
      <div id="upper-marquee">
        CREADO POR FX PRODUCCIONES - CEL.: 79146582 - 63642087, CHALLAPATA - ORURO - BOLIVIA
      </div>
      <div id="upper-third">Cr√©ditos: <span id="credits">0</span></div>
    </section>
    <!-- Panel Derecho -->
    <div id="sidebar-right">
      <section id="queue-section">
        <h2>Cola de Reproducci√≥n</h2>
        <ul id="play-queue"></ul>
      </section>
    </div>
    <!-- Botones de Acci√≥n -->
    <button id="select-folder">üìÅ</button>
    <button id="theme-toggle">üåô</button>
  </div>
  <script>
    // Variables globales
    let folderHandle = null;
    let credits = 0;
    const playQueue = [];
    let selectedLetterIndex = -1;
    let currentOpenGroup = null;
    let currentGroupVideos = [];
    let selectedVideoIndex = -1;

    // Elementos del DOM
    const availableVideosList = document.getElementById("available-videos");
    const previewVideo = document.getElementById("preview-video");
    const playQueueList = document.getElementById("play-queue");
    const mainVideo = document.getElementById("main-video");
    const lowerThird = document.getElementById("lower-third");
    const upperThird = document.getElementById("upper-third");
    const vinyl = document.getElementById("vinyl");
    const creditCount = document.getElementById("credits");
    const selectFolderButton = document.getElementById("select-folder");
    const addCreditButton = document.getElementById("add-credit");
    const themeToggle = document.getElementById("theme-toggle");

    // L√≥gica de cambio de tema
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("light-mode");
      themeToggle.textContent = document.body.classList.contains("light-mode") ? "üåô" : "‚òÄÔ∏è";
    });

    // Seleccionar carpeta
    selectFolderButton.addEventListener("click", async () => {
      try {
        folderHandle = await window.showDirectoryPicker();
        localStorage.setItem("selectedFolder", folderHandle);
        availableVideosList.innerHTML = "";
        await loadVideosFromFolder(folderHandle);
        sortGroups();
      } catch (error) {
        alert("No se pudo acceder a la carpeta.");
      }
    });

    // Cargar videos recursivamente
    async function loadVideosFromFolder(folder) {
      for await (const entry of folder.values()) {
        if (entry.kind === "file" && isVideoFile(entry.name)) {
          const file = await entry.getFile();
          addVideoToList(file.name, URL.createObjectURL(file));
        } else if (entry.kind === "directory") {
          await loadVideosFromFolder(entry);
        }
      }
    }

    // Verificar extensiones
    function isVideoFile(fileName) {
      const extensions = [".mp4", ".avi", ".mkv", ".mov", ".webm", ".dat", ".mpg", ".mpeg", ".vob", ".wmv", ".flv"];
      return extensions.includes(fileName.slice(fileName.lastIndexOf(".")).toLowerCase());
    }

    // Agregar video a la lista
    function addVideoToList(name, src) {
      let [author, title] = name.includes(" - ") ? name.split(" - ", 2) : ["Desconocido", name];
      title = title.replace(/\.[^/.]+$/, "").trim();
      author = author.trim();
      const firstChar = getFirstCharacter(author);
      let group = Array.from(availableVideosList.children).find(g => g.dataset.group === firstChar);

      if (!group) {
        group = document.createElement("div");
        group.className = "letter-group";
        group.dataset.group = firstChar;

        const header = document.createElement("div");
        header.className = "letter-header";
        header.textContent = firstChar;
        header.addEventListener("click", () => toggleGroup(group));

        const content = document.createElement("div");
        content.className = "letter-content";
        const ul = document.createElement("ul");
        content.appendChild(ul);

        group.appendChild(header);
        group.appendChild(content);
        availableVideosList.appendChild(group);
      }

      const li = document.createElement("li");
      li.textContent = `${author} - ${title}`;
      li.dataset.src = src;
      group.querySelector("ul").appendChild(li);
    }

    // Obtener primer car√°cter
    function getFirstCharacter(text) {
      const firstChar = text.charAt(0);
      if (/[a-zA-Z]/.test(firstChar)) return firstChar.toUpperCase();
      if (/\d/.test(firstChar)) return "#";
      return "@";
    }

    // Ordenar grupos
    function sortGroups() {
      const groups = Array.from(availableVideosList.children);
      groups.sort((a, b) => {
        const groupA = a.dataset.group;
        const groupB = b.dataset.group;
        if (groupA === groupB) return 0;
        if (groupA === "@") return -1;
        if (groupB === "@") return 1;
        if (groupA === "#") return 1;
        if (groupB === "#") return -1;
        return groupA.localeCompare(groupB);
      });
      availableVideosList.innerHTML = "";
      groups.forEach(group => availableVideosList.appendChild(group));
    }

    // Control de grupos
    function toggleGroup(group) {
      const content = group.querySelector(".letter-content");
      const isOpen = content.classList.contains("open");
      
      if (isOpen) {
        content.style.maxHeight = "0";
        setTimeout(() => {
          currentOpenGroup = null;
          currentGroupVideos = [];
          selectedVideoIndex = -1;
          updateSelection();
        }, 300);
      } else {
        closeAllGroups();
        content.style.maxHeight = content.scrollHeight + "px";
        currentOpenGroup = group;
        currentGroupVideos = Array.from(group.querySelectorAll("li"));
        selectedVideoIndex = 0;
		          updateSelection();
        scrollIntoView(group);
      }
    }

    // Cerrar todos los grupos
    function closeAllGroups() {
      Array.from(availableVideosList.querySelectorAll(".letter-content"))
        .forEach(content => content.style.maxHeight = "0");
    }

    // Navegaci√≥n mediante teclado
    document.addEventListener("keydown", (event) => {
      const groups = Array.from(availableVideosList.querySelectorAll(".letter-group"));
      if (groups.length === 0) return;

      // Flecha abajo
      if (event.key === "ArrowDown") {
        event.preventDefault();
        if (currentOpenGroup) {
          if (selectedVideoIndex < currentGroupVideos.length - 1) {
            selectedVideoIndex++;
          } else {
            const nextGroupIndex = groups.indexOf(currentOpenGroup) + 1;
            if (nextGroupIndex < groups.length) {
              toggleGroup(groups[nextGroupIndex]);
            }
          }
        } else {
          selectedLetterIndex = Math.min(selectedLetterIndex + 1, groups.length - 1);
        }
        updateSelection();
      }

      // Flecha arriba
      if (event.key === "ArrowUp") {
        event.preventDefault();
        if (currentOpenGroup) {
          if (selectedVideoIndex > 0) {
            selectedVideoIndex--;
          } else {
            const prevGroupIndex = groups.indexOf(currentOpenGroup) - 1;
            if (prevGroupIndex >= 0) {
              toggleGroup(groups[prevGroupIndex]);
            }
          }
        } else {
          selectedLetterIndex = Math.max(selectedLetterIndex - 1, 0);
        }
        updateSelection();
      }

      // Abrir grupo con flecha derecha
      if (event.key === "ArrowRight" && !currentOpenGroup) {
        event.preventDefault();
        if (selectedLetterIndex !== -1) toggleGroup(groups[selectedLetterIndex]);
      }

      // Mostrar solo categor√≠as con flecha izquierda
      if (event.key === "ArrowLeft") {
        event.preventDefault();
        if (currentOpenGroup) {
          closeAllGroups();
          selectedLetterIndex = groups.indexOf(currentOpenGroup);
          currentOpenGroup = null;
          currentGroupVideos = [];
          selectedVideoIndex = -1;
          updateSelection();
        }
      }

      // Agregar a cola con espacio
      if (event.key === " " && currentOpenGroup) {
        event.preventDefault();
        if (credits > 0) {
          const video = currentGroupVideos[selectedVideoIndex];
          addToQueue({ name: video.textContent, src: video.dataset.src });
        } else {
          alert("No tienes cr√©ditos suficientes.");
        }
      }

      // Modo pantalla completa (tecla 0)
      if (event.key === "0") {
        event.preventDefault();
        if (!document.fullscreenElement) {
          document.getElementById("main-screen").requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      // Agregar cr√©dito (tecla 1)
      if (event.key === "1") {
        event.preventDefault();
        credits++;
        updateCreditsDisplay();
      }
    });

    // Scroll autom√°tico
    function scrollIntoView(element) {
      element.scrollIntoView({
        behavior: "smooth",
        block: "center",
        inline: "nearest"
      });
    }

    // Actualizar selecci√≥n visual
    function updateSelection() {
      // Resaltar grupo seleccionado
      Array.from(availableVideosList.querySelectorAll(".letter-header"))
        .forEach((header, index) => {
          header.classList.toggle("selected", index === selectedLetterIndex);
        });

      // Resaltar video seleccionado
      Array.from(availableVideosList.querySelectorAll("li"))
        .forEach(video => video.classList.remove("selected"));
      
      if (currentOpenGroup && selectedVideoIndex !== -1) {
        const selectedVideo = currentGroupVideos[selectedVideoIndex];
        selectedVideo.classList.add("selected");
        previewVideo.src = selectedVideo.dataset.src;
        previewVideo.play();
        scrollIntoView(selectedVideo);
      }
    }

    // Agregar a cola (ahora requiere cr√©dito)
    function addToQueue(video) {
      if (credits <= 0) return;

      credits--;
      playQueue.push(video);
      updateQueueDisplay();

      // Mostrar el disco vinilo cuando se agrega un video a la cola
      vinyl.style.display = "block";

      if (mainVideo.paused) {
        playNextVideo();
      }
    }

    // Reproducir video
    function playVideo(video) {
      mainVideo.src = video.src;
      mainVideo.play();
      const [title, author] = video.name.split(" - ");
      lowerThird.textContent = `${title || "T√çTULO"} - ${author || "AUTOR"}`;
      lowerThird.style.display = "block";

      // Mostrar el disco vinilo durante la reproducci√≥n
      vinyl.style.display = "block";

      mainVideo.onended = () => {
        lowerThird.style.display = "none";
        playNextVideo();
      };
    }

    // Actualizar cola
    function updateQueueDisplay() {
      playQueueList.innerHTML = "";
      playQueue.forEach(video => {
        const li = document.createElement("li");
        li.textContent = video.name;
        playQueueList.appendChild(li);
      });
    }

    // Reproducir siguiente video
    function playNextVideo() {
      if (playQueue.length > 0) {
        const nextVideo = playQueue.shift();
        playVideo(nextVideo);
        updateQueueDisplay();
      } else {
        // Ocultar el disco vinilo si no hay videos en cola
        vinyl.style.display = "none";
      }
    }

    // Actualizar cr√©ditos
    function updateCreditsDisplay() {
      creditCount.textContent = credits;
      upperThird.textContent = `Cr√©ditos: ${credits}`;
    }

    addCreditButton.addEventListener("click", () => {
      credits++;
      updateCreditsDisplay();
    });
  </script>
</body>
</html>